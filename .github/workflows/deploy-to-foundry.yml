name: Deploy AI Agent to Azure AI Foundry

# Trigger the workflow on push to main branch
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.9'
  AGENT_NAME: 'simple-ai-agent'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    # Step 1: Checkout the code
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # Step 2: Set up Python
    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # Step 3: Install dependencies
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install azure-cli azure-ai-projects azure-identity
    
    # Step 4: Run tests (optional - add your tests here)
    - name: ðŸ§ª Run tests
      run: |
        echo "Running tests..."
        # Add your test commands here, e.g.:
        # pytest tests/
        echo "âœ… Tests passed!"
    
    # Step 5: Login to Azure using OIDC
    - name: ðŸ” Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    # Step 6: Verify Azure Resources
    - name: âš™ï¸ Verify Azure Resources
      run: |
        echo "Verifying Azure AI Foundry resources..."
        az cognitiveservices account show \
          --name ${{ secrets.AI_FOUNDRY_PROJECT_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
        echo "âœ… AI Foundry project verified!"
    
    # Step 7: Package agent code
    - name: ðŸ“¦ Package agent
      run: |
        echo "Packaging agent code..."
        zip -r agent-package.zip agent/ requirements.txt conda.yaml
        echo "âœ… Agent packaged!"
    
    # Step 8: Deploy agent to AI Foundry
    - name: ðŸš€ Deploy agent to AI Foundry
      run: |
        echo "Deploying agent to Azure AI Foundry..."
        echo "Project: ${{ secrets.AI_FOUNDRY_PROJECT_NAME }}"
        echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
        
        # Run the deployment script
        python deploy_to_foundry.py
      env:
        RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        PROJECT_NAME: ${{ secrets.AI_FOUNDRY_PROJECT_NAME }}
        SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}
    
    # Step 9: Verify deployment
    - name: ðŸ§ª Verify deployment
      run: |
        echo "Verifying agent deployment..."
        
        # Extract version from agent code
        VERSION=$(python -c "import sys; sys.path.insert(0, 'agent'); from simple_agent import __version__, __deployment_date__; print(f'v{__version__} ({__deployment_date__})')")
        echo "ðŸ“Œ Deployed Version: $VERSION"
        
        # Show git commit info
        COMMIT_HASH=$(git rev-parse --short HEAD)
        COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
        COMMIT_MSG=$(git log -1 --pretty=format:'%s')
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        echo "ðŸ“ Git Commit: $COMMIT_HASH"
        echo "ðŸ‘¤ Author: $COMMIT_AUTHOR"
        echo "ðŸ’¬ Message: $COMMIT_MSG"
        echo "â° Time: $TIMESTAMP"
        
        # Update deployment history file
        cat > DEPLOYMENT_TRACKING.txt << EOF
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘         LATEST DEPLOYMENT INFORMATION                      â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Version:        $VERSION
        Git Commit:     $COMMIT_HASH
        Author:         $COMMIT_AUTHOR
        Message:        $COMMIT_MSG
        Timestamp:      $TIMESTAMP
        Project:        ${{ secrets.AI_FOUNDRY_PROJECT_NAME }}
        Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        This file is auto-generated by GitHub Actions on every deployment.
        Check the timestamp to see when the last deployment occurred.
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EOF
        
        cat DEPLOYMENT_TRACKING.txt
        
        echo ""
        echo "âœ… Agent code uploaded successfully!"
        echo "âœ… Configuration validated!"
        echo "âœ… Deployment complete!"
        echo "âœ… Deployment tracking updated!"
    
    
    
    # Step 10: Output deployment information
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "==================================================="
        echo "ðŸŽ‰ Deployment Complete!"
        echo "==================================================="
        echo "Agent Name: ${{ env.AGENT_NAME }}"
        echo "Project: ${{ secrets.AI_FOUNDRY_PROJECT_NAME }}"
        echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
        echo ""
        echo "âœ… Code deployed successfully!"
        echo "âœ… Agent is ready in Azure AI Foundry!"
        echo ""
        echo "Next steps:"
        echo "1. Go to https://ai.azure.com"
        echo "2. Navigate to your project"
        echo "3. Test your agent in the playground"
        echo "4. Configure additional deployments as needed"
        echo "==================================================="
